# Linux makefile for FreeImage

# This file can be generated by ./gensrclist.sh
include Makefile.srcs

# General configuration variables:
CC = gcc
CXX = g++
AR = ar

PREFIX=/usr
INCDIR = $(PREFIX)/include
INSTALLDIR = $(PREFIX)/lib

# Mods to make a local install work
LOCAL_INSTALL_OPTS=
LOCAL_LDCONFIG_CMD=
GLOBAL_INSTALL_OPTS= -o root -g root
GLOBAL_LDCONFIG_CMD= ldconfig

ifeq ($(PREFIX),/usr/)
INSTALL_OPTS= $(GLOBAL_INSTALL_OPTS)
LDCONFIG= $(GLOBAL_LDCONFIG_CMD)
else ifeq  ($(PREFIX),/usr/local/)
INSTALL_OPTS= $(GLOBAL_INSTALL_OPTS)
LDCONFIG= $(GLOBAL_LDCONFIG_CMD)
else
INSTALL_OPTS= $(LOCAL_INSTALL_OPTS)
LDCONFIG= $(LOCAL_LDCONFIG_CMD)
endif


# Converts cr/lf to just lf
DOS2UNIX = dos2unix

COMPILERFLAGS = -O3
LIBRARIES = -lstdc++

MODULES = $(SRCS:.c=.o)
MODULES := $(MODULES:.cpp=.o)
CFLAGS = $(COMPILERFLAGS) $(INCLUDE)
CXXFLAGS = $(COMPILERFLAGS)  -Wno-ctor-dtor-privacy $(INCLUDE)

TARGET  = freeimage
STATICLIB = lib$(TARGET).a
SHAREDLIB = lib$(TARGET)-$(VER_MAJOR).$(VER_MINOR).so
LIBNAME	= lib$(TARGET).so
VERLIBNAME = $(LIBNAME).$(VER_MAJOR)
HEADER = Source/FreeImage.h



default: all

all: dist

dist: FreeImage
	cp *.a Dist
	cp *.so Dist
	cp Source/FreeImage.h Dist

dos2unix:
	@$(DOS2UNIX) $(SRCS) $(INCLS)

FreeImage: $(STATICLIB) $(SHAREDLIB)

.c.o:
	$(CC) $(CFLAGS) -c $< -o $@

.cpp.o:
	$(CXX) $(CXXFLAGS) -c $< -o $@

$(STATICLIB): $(MODULES)
	$(AR) r $@ $(MODULES)

$(SHAREDLIB): $(MODULES)
	$(CC) -s -shared -Wl,-soname,$(VERLIBNAME) -o $@ $(MODULES) $(LIBRARIES)

install:
	mkdir -p $(INCDIR)
	mkdir -p $(INSTALLDIR)
	install -m 644 ${INSTALL_OPTS} $(HEADER) $(INCDIR)
	install -m 644 ${INSTALL_OPTS} $(STATICLIB) $(INSTALLDIR)
	install -m 755 ${INSTALL_OPTS} $(SHAREDLIB) $(INSTALLDIR)
	ln -sf $(SHAREDLIB) $(INSTALLDIR)/$(VERLIBNAME)
	ln -sf $(VERLIBNAME) $(INSTALLDIR)/$(LIBNAME)	
	$(LDCONFIG)

clean:
	rm -f core Dist/*.* u2dtmp* $(MODULES) $(STATICLIB) $(SHAREDLIB) $(LIBNAME)

osx:
	$(MAKE) -f Makefile.osx

osxinstall:
	$(MAKE) -f Makefile.osx install
